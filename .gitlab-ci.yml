# 1. Define the stages
stages:
  - build
  - test
  - publish

# 2. Define DOCKER variables
variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  # CRITICAL FIX: Simplify the image name to remove the complex path
  # This uses the image name based only on the project name, which is often lowercase.
  IMAGE_NAME: $CI_REGISTRY/$CI_PROJECT_NAME/my-app 
  
  # Note: CI_PROJECT_NAME is the repo name (e.g., ci-cd-docker).
  # If the repo name has capitals, this will fail, but it's the simplest fix.

# --- Shared Configuration ---
.docker-job:
# ... (rest of the shared config is fine)

# --- JOB 1: Build the Docker Image ---
build-image:
  extends: .docker-job
  stage: build
  script:
    - echo "--- Building Docker Image (Job 1) ---"
    
    # We will log the final tag here to see what the variable resolves to
    - echo "Final Image Tag: $CI_REGISTRY/$CI_PROJECT_NAME/my-app:$CI_COMMIT_SHORT_SHA"
    
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    
    - docker build -t $CI_REGISTRY/$CI_PROJECT_NAME/my-app:$CI_COMMIT_SHORT_SHA .
    - docker push $CI_REGISTRY/$CI_PROJECT_NAME/my-app:$CI_COMMIT_SHORT_SHA
# ...