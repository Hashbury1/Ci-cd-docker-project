name: Simple Docker CI

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get repository name (lowercase)
        id: repo
        run: |
          echo "name=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
          echo "sha=$(echo ${{ github.sha }} | cut -c1-8)" >> $GITHUB_OUTPUT

      - name: Build Docker image
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ steps.repo.outputs.name }}"
          echo "Building: ${IMAGE}:${{ steps.repo.outputs.sha }}"
          
          docker build -t ${IMAGE}:${{ steps.repo.outputs.sha }} .
          docker tag ${IMAGE}:${{ steps.repo.outputs.sha }} ${IMAGE}:latest
          
          echo "IMAGE=${IMAGE}" >> $GITHUB_ENV
          echo "TAG=${{ steps.repo.outputs.sha }}" >> $GITHUB_ENV

      - name: Push Docker image
        run: |
          echo "Pushing ${IMAGE}:${TAG}"
          docker push ${IMAGE}:${TAG}
          
          echo "Pushing ${IMAGE}:latest"
          docker push ${IMAGE}:latest

      - name: Verify push
        run: |
          echo "Verifying image was pushed..."
          docker pull ${IMAGE}:${TAG}
          echo "✅ Image successfully pushed and verified!"

      - name: Run tests
        run: |
          echo "Running tests in container..."
          docker run --rm ${IMAGE}:${TAG} npm test

      - name: Success summary
        run: |
          echo "### ✅ Build and Test Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${IMAGE}:${TAG}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Also tagged as:** \`${IMAGE}:latest\`" >> $GITHUB_STEP_SUMMARY